(function(b){function a(c){return("".trim)?c.val().trim():b.trim(c.val())}b.fn.isHappy=function(e){var d=[],g;function i(j){return b('<span id="'+j.id+'" class="unhappyMessage">'+j.message+"</span>")}function c(){var m=false,k,j;for(k=0,j=d.length;k<j;k+=1){if(!d[k].testValid(true)){m=true}}if(m){if(h(e.unHappy)){e.unHappy()}return false}else{if(e.testMode){if(window.console){console.warn("would have submitted")}return false}}}function h(j){return !!(j&&j.constructor&&j.call&&j.apply)}function f(l,j){var m=b(j),k={message:l.message,id:j.slice(1)+"_unhappy"},n=b(k.id).length>0?b(k.id):i(k);d.push(m);m.testValid=function(s){var p,o=b(this),q,t=false,v,r=!!o.get(0).attributes.getNamedItem("required")||l.required,u=(m.attr("type")==="password"),w=h(l.arg)?l.arg():l.arg;if(h(l.clean)){p=l.clean(o.val())}else{if(!l.trim&&!u){p=a(o)}else{p=o.val()}}o.val(p);q=((p.length>0||r==="sometimes")&&h(l.test));if(s===true&&r===true&&p.length===0){t=true}else{if(q){t=!l.test(p,w)}}if(t){o.addClass("unhappy").before(n);return false}else{v=n.get(0);if(v.parentNode){v.parentNode.removeChild(v)}o.removeClass("unhappy");return true}};m.bind(e.when||"blur",m.testValid)}for(g in e.fields){f(e.fields[g],g)}if(e.submitButton){b(e.submitButton).click(c)}else{this.bind("submit",c)}return this}})(this.jQuery||this.Zepto);